import{H3Event as l,deleteCookie as w,getCookie as _,setCookie as A,sendRedirect as T,setResponseStatus as q,setHeader as $,getRequestIP as E,getResponseStatus as k,getResponseStatusText as L,getResponseHeader as W,setResponseHeader as P,removeResponseHeader as j,appendResponseHeader as I,getResponseHeaders as O,getRequestURL as U,getRequestWebStream as F,sendWebResponse as N,useSession as K}from"h3";import g from"vite-plugin-node-polyfills/shims/global";import{AsyncLocalStorage as M}from"node:async_hooks";function B(t={}){let e,s=!1;const r=n=>{if(e&&e!==n)throw new Error("Context conflict")};let a;if(t.asyncContext){const n=t.AsyncLocalStorage||globalThis.AsyncLocalStorage;n?a=new n:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const f=()=>{if(a){const n=a.getStore();if(n!==void 0)return n}return e};return{use:()=>{const n=f();if(n===void 0)throw new Error("Context is not available");return n},tryUse:()=>f(),set:(n,i)=>{i||r(n),e=n,s=!0},unset:()=>{e=void 0,s=!1},call:(n,i)=>{r(n),e=n;try{return a?a.run(n,i):i()}finally{s||(e=void 0)}},async callAsync(n,i){e=n;const C=()=>{e=n},p=()=>e===n?C:void 0;h.add(p);try{const v=a?a.run(n,i):i();return s||(e=void 0),await v}finally{h.delete(p)}}}}function z(t={}){const e={};return{get(s,r={}){return e[s]||(e[s]=B({...t,...r})),e[s]}}}const u=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof g<"u"?g:typeof window<"u"?window:{},y="__unctx__",D=u[y]||(u[y]=z()),G=(t,e={})=>D.get(t,e),R="__unctx_async_handlers__",h=u[R]||(u[R]=new Set);function pe(t){return t}function J(t){let e;const s=H(t),r={duplex:"half",method:t.method,headers:t.headers};return t.node.req.body instanceof ArrayBuffer?new Request(s,{...r,body:t.node.req.body}):new Request(s,{...r,get body(){return e||(e=se(t),e)}})}function Q(t){return t.web??={request:J(t),url:H(t)},t.web.request}function V(){return ae()}const x=Symbol("$HTTPEvent");function X(t){return typeof t=="object"&&(t instanceof l||t?.[x]instanceof l||t?.__is_event__===!0)}function o(t){return function(...e){let s=e[0];if(X(s))e[0]=s instanceof l||s.__is_event__?s:s[x];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(s=V(),!s)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");e.unshift(s)}return t(...e)}}const H=o(U),Y=o(E),b=o(q),S=o(k),Z=o(L),c=o(O),m=o(W),ee=o(P),te=o(I),ge=o(T),ye=o(_),Re=o(A),he=o(w),be=o(K),Se=o(N),me=o($),se=o(F),ne=o(j),oe=o(Q);function re(){return G("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:M})}function ae(){return re().use().event}const d="solidFetchEvent";function ie(t){return{request:oe(t),response:ue(t),clientAddress:Y(t),locals:{},nativeEvent:t}}function xe(t){return{...t}}function He(t){if(!t.context[d]){const e=ie(t);t.context[d]=e}return t.context[d]}class ce{event;constructor(e){this.event=e}get(e){const s=m(this.event,e);return Array.isArray(s)?s.join(", "):s||null}has(e){return this.get(e)!==void 0}set(e,s){return ee(this.event,e,s)}delete(e){return ne(this.event,e)}append(e,s){te(this.event,e,s)}getSetCookie(){const e=m(this.event,"Set-Cookie");return Array.isArray(e)?e:[e]}forEach(e){return Object.entries(c(this.event)).forEach(([s,r])=>e(Array.isArray(r)?r.join(", "):r,s,this))}entries(){return Object.entries(c(this.event)).map(([e,s])=>[e,Array.isArray(s)?s.join(", "):s])[Symbol.iterator]()}keys(){return Object.keys(c(this.event))[Symbol.iterator]()}values(){return Object.values(c(this.event)).map(e=>Array.isArray(e)?e.join(", "):e)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function ue(t){return{get status(){return S(t)},set status(e){b(t,e)},get statusText(){return Z(t)},set statusText(e){b(t,S(t),e)},headers:new ce(t)}}export{ye as a,Re as b,ge as c,pe as d,b as e,me as f,He as g,he as h,xe as i,Se as s,be as u};
