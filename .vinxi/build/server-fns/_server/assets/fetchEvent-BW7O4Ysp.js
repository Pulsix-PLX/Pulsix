import{H3Event as f,deleteCookie as _,getCookie as A,setCookie as T,setResponseStatus as q,setHeader as $,appendResponseHeader as E,getRequestIP as k,parseCookies as L,getResponseStatus as W,getResponseStatusText as P,getResponseHeader as j,setResponseHeader as I,removeResponseHeader as O,getResponseHeaders as U,getRequestURL as F,getRequestWebStream as N,sendWebResponse as K,useSession as M}from"h3";import g from"vite-plugin-node-polyfills/shims/global";import{AsyncLocalStorage as B}from"node:async_hooks";function z(t={}){let e,s=!1;const r=n=>{if(e&&e!==n)throw new Error("Context conflict")};let a;if(t.asyncContext){const n=t.AsyncLocalStorage||globalThis.AsyncLocalStorage;n?a=new n:console.warn("[unctx] `AsyncLocalStorage` is not provided.")}const l=()=>{if(a){const n=a.getStore();if(n!==void 0)return n}return e};return{use:()=>{const n=l();if(n===void 0)throw new Error("Context is not available");return n},tryUse:()=>l(),set:(n,i)=>{i||r(n),e=n,s=!0},unset:()=>{e=void 0,s=!1},call:(n,i)=>{r(n),e=n;try{return a?a.run(n,i):i()}finally{s||(e=void 0)}},async callAsync(n,i){e=n;const v=()=>{e=n},p=()=>e===n?v:void 0;R.add(p);try{const w=a?a.run(n,i):i();return s||(e=void 0),await w}finally{R.delete(p)}}}}function D(t={}){const e={};return{get(s,r={}){return e[s]||(e[s]=z({...t,...r})),e[s]}}}const u=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof g<"u"?g:typeof window<"u"?window:{},y="__unctx__",G=u[y]||(u[y]=D()),J=(t,e={})=>G.get(t,e),h="__unctx_async_handlers__",R=u[h]||(u[h]=new Set);function pe(t){return t}function Q(t){let e;const s=C(t),r={duplex:"half",method:t.method,headers:t.headers};return t.node.req.body instanceof ArrayBuffer?new Request(s,{...r,body:t.node.req.body}):new Request(s,{...r,get body(){return e||(e=se(t),e)}})}function V(t){return t.web??={request:Q(t),url:C(t)},t.web.request}function X(){return ae()}const x=Symbol("$HTTPEvent");function Y(t){return typeof t=="object"&&(t instanceof f||t?.[x]instanceof f||t?.__is_event__===!0)}function o(t){return function(...e){let s=e[0];if(Y(s))e[0]=s instanceof f||s.__is_event__?s:s[x];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(s=X(),!s)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");e.unshift(s)}return t(...e)}}const C=o(F),Z=o(k),b=o(q),S=o(W),ee=o(P),c=o(U),m=o(j),te=o(I),H=o(E),ge=o(L),ye=o(A),he=o(T),Re=o(_),be=o(M),Se=o(K),me=o($),se=o(N),ne=o(O),oe=o(V);function re(){return J("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:B})}function ae(){return re().use().event}const d="solidFetchEvent";function ie(t){return{request:oe(t),response:ue(t),clientAddress:Z(t),locals:{},nativeEvent:t}}function xe(t){return{...t}}function Ce(t){if(!t.context[d]){const e=ie(t);t.context[d]=e}return t.context[d]}function He(t,e){for(const[s,r]of e.entries())H(t,s,r)}class ce{event;constructor(e){this.event=e}get(e){const s=m(this.event,e);return Array.isArray(s)?s.join(", "):s||null}has(e){return this.get(e)!==void 0}set(e,s){return te(this.event,e,s)}delete(e){return ne(this.event,e)}append(e,s){H(this.event,e,s)}getSetCookie(){const e=m(this.event,"Set-Cookie");return Array.isArray(e)?e:[e]}forEach(e){return Object.entries(c(this.event)).forEach(([s,r])=>e(Array.isArray(r)?r.join(", "):r,s,this))}entries(){return Object.entries(c(this.event)).map(([e,s])=>[e,Array.isArray(s)?s.join(", "):s])[Symbol.iterator]()}keys(){return Object.keys(c(this.event))[Symbol.iterator]()}values(){return Object.values(c(this.event)).map(e=>Array.isArray(e)?e.join(", "):e)[Symbol.iterator]()}[Symbol.iterator](){return this.entries()[Symbol.iterator]()}}function ue(t){return{get status(){return S(t)},set status(e){b(t,e)},get statusText(){return ee(t)},set statusText(e){b(t,S(t),e)},headers:new ce(t)}}export{ye as a,he as b,b as c,pe as d,me as e,xe as f,Ce as g,Re as h,He as m,ge as p,Se as s,be as u};
