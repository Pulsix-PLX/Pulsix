import o from"vite-plugin-node-polyfills/shims/process";import{c as a}from"./server-fns-runtime-C3tiYEg6.js";import c from"bcryptjs";import*as i from"jose";import u from"jsonwebtoken";import{v4 as n}from"uuid";import{d as _}from"./db.server-CDeyn5Z_.js";const l=o.env.JWT_SECRET||"",f=o.env.JWT_ISSUER||"app",E=Number(o.env.ACCESS_TOKEN_EXPIRY)||900,d=Number(o.env.REFRESH_TOKEN_EXPIRY)||1209600,g=a(function(r){const e={sub:r,jti:n()};return u.sign(e,l,{algorithm:"HS256",expiresIn:E,issuer:f})},"src_routes_API_Auth_login_utils_ts--generateAccessToken_1","C:/Users/Matteo/Desktop/Pulsix/src/routes/API/Auth/login/utils.ts?tsr-directive-use-server="),w=g,h=a(async function(){const r=await k(),e=new Date;e.setSeconds(e.getSeconds()+d);try{return{token:r,expires_at:e}}catch(t){throw console.error("Errore durante la memorizzazione del refresh token:",t),new Error("Impossibile generare il refresh token a causa di un errore del database.")}},"src_routes_API_Auth_login_utils_ts--generateRefreshToken_1","C:/Users/Matteo/Desktop/Pulsix/src/routes/API/Auth/login/utils.ts?tsr-directive-use-server="),I=h;async function k(){const s=await i.generateSecret("HS256"),r=n()+n();return await new i.CompactSign(new TextEncoder().encode(r)).setProtectedHeader({alg:"HS256"}).sign(s)}a(async function(r){try{const e=await _.query(`SELECT user_id, token_hash, expires_at FROM auth.active_sessions 
       WHERE expires_at > NOW()`);if(e.rows.length===0)return null;for(const t of e.rows)if(await c.compare(r,t.token_hash))return t.user_id;return null}catch(e){return console.error("Errore durante la verifica del refresh token:",e),null}},"src_routes_API_Auth_login_utils_ts--verifyRefreshToken_1","C:/Users/Matteo/Desktop/Pulsix/src/routes/API/Auth/login/utils.ts?tsr-directive-use-server=");export{I as a,w as g};
